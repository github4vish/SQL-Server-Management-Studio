USE [bhoruka_v9_traxx_new]
GO

/****** Object:  Table [dbo].[depreciation]    Script Date: 12/5/2017 4:13:35 PM ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO

CREATE TABLE [dbo].[depreciation](
	[assetid] [varchar](max) NOT NULL,
	[ast_id] [int] NOT NULL,
	[group_id] [int] NULL,
	[costcenter_id] [varchar](50) NOT NULL,
	[old_in_dt] [date] NULL,
	[in_dt] [date] NULL,
	[un_dt] [date] NULL,
	[dis_dt] [date] NULL,
	[old_cost] [float] NULL,
	[cost] [float] NULL,
	[old_acc_dep] [float] NULL,
	[old_wdv] [float] NULL,
	[depreciate] [varchar](50) NULL,
	[life] [float] NULL,
	[death]  AS (case when [un_dt] IS NULL then dateadd(year,[life]/(12),dateadd(day,(-1),[old_in_dt])) else [un_dt] end),
	[dis_death]  AS (case when [dis_dt]<case when [un_dt] IS NULL then dateadd(year,[life]/(12),dateadd(day,(-1),[old_in_dt])) else [un_dt] end then [dis_dt] else case when [un_dt] IS NULL then dateadd(year,[life]/(12),dateadd(day,(-1),[old_in_dt])) else [un_dt] end end),
	[end_dt] [date] NULL,
	[life_days] [float] NULL,
	[val]  AS (case when [old_wdv] IS NULL then [cost] else [old_wdv] end),
	[ddep]  AS (round([cost]/[life_days],(2))),
	[jan17_dep]  AS (case when [depreciate]='N' OR [in_dt]>'2017-01-31' OR [end_dt]<'2017-01-01' OR [dis_dt]<'2017-01-01' then '0' else case when '2017-01-31'>[end_dt] then (datediff(day,[in_dt],[end_dt])+'1')*([cost]/[life_days]) else (datediff(day,[in_dt],'2017-01-31')+'1')*([cost]/[life_days]) end end),
	[jan17_wdv]  AS ([old_wdv]),
	[jan17_acc_dep]  AS ([old_acc_dep]),
	[feb17_dep]  AS (case when [depreciate]='N' OR [in_dt]>'2017-02-28' OR [end_dt]<'2017-02-01' OR [dis_dt]<'2017-02-01' then '0' else case when '2017-02-28'>[end_dt] then [old_acc_dep]+(datediff(day,[in_dt],[end_dt])+'1')*round([cost]/[life_days],(2)) else [old_acc_dep]+(datediff(day,[in_dt],'2017-02-28')+'1')*round([cost]/[life_days],(2)) end-[old_acc_dep] end),
	[feb17_wdv]  AS (case when [depreciate]='N' OR [in_dt]>'2017-02-28' OR [end_dt]<'2017-02-01' OR [dis_dt]<'2017-02-01' then '0' else [old_cost]-case when '2017-02-28'>[end_dt] then [old_acc_dep]+(datediff(day,[in_dt],[end_dt])+'1')*round([cost]/[life_days],(2)) else [old_acc_dep]+(datediff(day,[in_dt],'2017-02-28')+'1')*round([cost]/[life_days],(2)) end end),
	[feb17_acc_dep]  AS (case when [depreciate]='N' OR [in_dt]>'2017-02-28' OR [end_dt]<'2017-02-01' OR [dis_dt]<'2017-02-01' then '0' else case when '2017-02-28'>[end_dt] then [old_acc_dep]+(datediff(day,[in_dt],[end_dt])+'1')*round([cost]/[life_days],(2)) else [old_acc_dep]+(datediff(day,[in_dt],'2017-02-28')+'1')*round([cost]/[life_days],(2)) end end),
	[mar17_dep]  AS (case when [depreciate]='N' OR [in_dt]>'2017-03-31' OR [end_dt]<'2017-03-01' OR [dis_dt]<'2017-03-01' then '0' else case when '2017-03-31'>[end_dt] then [old_acc_dep]+(datediff(day,[in_dt],[end_dt])+'1')*round([cost]/[life_days],(2)) else [old_acc_dep]+(datediff(day,[in_dt],'2017-03-31')+'1')*round([cost]/[life_days],(2)) end-case when [depreciate]='N' OR [in_dt]>'2017-02-28' OR [end_dt]<'2017-02-01' OR [dis_dt]<'2017-02-01' then '0' else case when '2017-02-28'>[end_dt] then [old_acc_dep]+(datediff(day,[in_dt],[end_dt])+'1')*round([cost]/[life_days],(2)) else [old_acc_dep]+(datediff(day,[in_dt],'2017-02-28')+'1')*round([cost]/[life_days],(2)) end end end),
	[mar17_wdv]  AS (case when [depreciate]='N' OR [in_dt]>'2017-03-31' OR [end_dt]<'2017-03-01' OR [dis_dt]<'2017-03-01' then '0' else [old_cost]-case when '2017-03-31'>[end_dt] then [old_acc_dep]+(datediff(day,[in_dt],[end_dt])+'1')*round([cost]/[life_days],(2)) else [old_acc_dep]+(datediff(day,[in_dt],'2017-03-31')+'1')*round([cost]/[life_days],(2)) end end),
	[mar17_acc_dep]  AS (case when [depreciate]='N' OR [in_dt]>'2017-03-31' OR [end_dt]<'2017-03-01' OR [dis_dt]<'2017-03-01' then '0' else case when '2017-03-31'>[end_dt] then [old_acc_dep]+(datediff(day,[in_dt],[end_dt])+'1')*round([cost]/[life_days],(2)) else [old_acc_dep]+(datediff(day,[in_dt],'2017-03-31')+'1')*round([cost]/[life_days],(2)) end end),
	[apr17_dep]  AS (case when [depreciate]='N' OR [in_dt]>'2017-04-30' OR [end_dt]<'2017-04-01' OR [dis_dt]<'2017-04-01' then '0' else case when '2017-04-30'>[end_dt] then [old_acc_dep]+(datediff(day,[in_dt],[end_dt])+'1')*round([cost]/[life_days],(2)) else [old_acc_dep]+(datediff(day,[in_dt],'2017-04-30')+'1')*round([cost]/[life_days],(2)) end-case when [depreciate]='N' OR [in_dt]>'2017-03-31' OR [end_dt]<'2017-03-01' OR [dis_dt]<'2017-03-01' then '0' else case when '2017-03-31'>[end_dt] then [old_acc_dep]+(datediff(day,[in_dt],[end_dt])+'1')*round([cost]/[life_days],(2)) else [old_acc_dep]+(datediff(day,[in_dt],'2017-03-31')+'1')*round([cost]/[life_days],(2)) end end end),
	[apr17_wdv]  AS (case when [depreciate]='N' OR [in_dt]>'2017-04-30' OR [end_dt]<'2017-04-01' OR [dis_dt]<'2017-04-01' then '0' else [old_cost]-case when '2017-04-30'>[end_dt] then [old_acc_dep]+(datediff(day,[in_dt],[end_dt])+'1')*round([cost]/[life_days],(2)) else [old_acc_dep]+(datediff(day,[in_dt],'2017-04-30')+'1')*round([cost]/[life_days],(2)) end end),
	[apr17_acc_dep]  AS (case when [depreciate]='N' OR [in_dt]>'2017-04-30' OR [end_dt]<'2017-04-01' OR [dis_dt]<'2017-04-01' then '0' else case when '2017-04-30'>[end_dt] then [old_acc_dep]+(datediff(day,[in_dt],[end_dt])+'1')*round([cost]/[life_days],(2)) else [old_acc_dep]+(datediff(day,[in_dt],'2017-04-30')+'1')*round([cost]/[life_days],(2)) end end),
	[may17_dep]  AS (case when [depreciate]='N' OR [in_dt]>'2017-05-31' OR [end_dt]<'2017-05-01' OR [dis_dt]<'2017-05-01' then '0' else case when '2017-05-31'>[end_dt] then [old_acc_dep]+(datediff(day,[in_dt],[end_dt])+'1')*round([cost]/[life_days],(2)) else [old_acc_dep]+(datediff(day,[in_dt],'2017-05-31')+'1')*round([cost]/[life_days],(2)) end-case when [depreciate]='N' OR [in_dt]>'2017-04-30' OR [end_dt]<'2017-04-01' OR [dis_dt]<'2017-04-01' then '0' else case when '2017-04-30'>[end_dt] then [old_acc_dep]+(datediff(day,[in_dt],[end_dt])+'1')*round([cost]/[life_days],(2)) else [old_acc_dep]+(datediff(day,[in_dt],'2017-04-30')+'1')*round([cost]/[life_days],(2)) end end end),
	[may17_wdv]  AS (case when [depreciate]='N' OR [in_dt]>'2017-05-31' OR [end_dt]<'2017-05-01' OR [dis_dt]<'2017-05-01' then '0' else [old_cost]-case when '2017-05-31'>[end_dt] then [old_acc_dep]+(datediff(day,[in_dt],[end_dt])+'1')*round([cost]/[life_days],(2)) else [old_acc_dep]+(datediff(day,[in_dt],'2017-05-31')+'1')*round([cost]/[life_days],(2)) end end),
	[may17_acc_dep]  AS (case when [depreciate]='N' OR [in_dt]>'2017-05-31' OR [end_dt]<'2017-05-01' OR [dis_dt]<'2017-05-01' then '0' else case when '2017-05-31'>[end_dt] then [old_acc_dep]+(datediff(day,[in_dt],[end_dt])+'1')*round([cost]/[life_days],(2)) else [old_acc_dep]+(datediff(day,[in_dt],'2017-05-31')+'1')*round([cost]/[life_days],(2)) end end),
	[jun17_dep]  AS (case when [depreciate]='N' OR [in_dt]>'2017-06-30' OR [end_dt]<'2017-06-01' OR [dis_dt]<'2017-06-01' then '0' else case when '2017-06-30'>[end_dt] then [old_acc_dep]+(datediff(day,[in_dt],[end_dt])+'1')*round([cost]/[life_days],(2)) else [old_acc_dep]+(datediff(day,[in_dt],'2017-06-30')+'1')*round([cost]/[life_days],(2)) end-case when [depreciate]='N' OR [in_dt]>'2017-05-31' OR [end_dt]<'2017-05-01' OR [dis_dt]<'2017-05-01' then '0' else case when '2017-05-31'>[end_dt] then [old_acc_dep]+(datediff(day,[in_dt],[end_dt])+'1')*round([cost]/[life_days],(2)) else [old_acc_dep]+(datediff(day,[in_dt],'2017-05-31')+'1')*round([cost]/[life_days],(2)) end end end),
	[jun17_wdv]  AS (case when [depreciate]='N' OR [in_dt]>'2017-06-30' OR [end_dt]<'2017-06-01' OR [dis_dt]<'2017-06-01' then '0' else [old_cost]-case when '2017-06-30'>[end_dt] then [old_acc_dep]+(datediff(day,[in_dt],[end_dt])+'1')*round([cost]/[life_days],(2)) else [old_acc_dep]+(datediff(day,[in_dt],'2017-06-30')+'1')*round([cost]/[life_days],(2)) end end),
	[jun17_acc_dep]  AS (case when [depreciate]='N' OR [in_dt]>'2017-06-30' OR [end_dt]<'2017-06-01' OR [dis_dt]<'2017-06-01' then '0' else case when '2017-06-30'>[end_dt] then [old_acc_dep]+(datediff(day,[in_dt],[end_dt])+'1')*round([cost]/[life_days],(2)) else [old_acc_dep]+(datediff(day,[in_dt],'2017-06-30')+'1')*round([cost]/[life_days],(2)) end end),
	[jul17_dep]  AS (case when [depreciate]='N' OR [in_dt]>'2017-07-31' OR [end_dt]<'2017-07-01' OR [dis_dt]<'2017-07-01' then '0' else case when '2017-07-31'>[end_dt] then [old_acc_dep]+(datediff(day,[in_dt],[end_dt])+'1')*round([cost]/[life_days],(2)) else [old_acc_dep]+(datediff(day,[in_dt],'2017-07-31')+'1')*round([cost]/[life_days],(2)) end-case when [depreciate]='N' OR [in_dt]>'2017-06-30' OR [end_dt]<'2017-06-01' OR [dis_dt]<'2017-06-01' then '0' else case when '2017-06-30'>[end_dt] then [old_acc_dep]+(datediff(day,[in_dt],[end_dt])+'1')*round([cost]/[life_days],(2)) else [old_acc_dep]+(datediff(day,[in_dt],'2017-06-30')+'1')*round([cost]/[life_days],(2)) end end end),
	[jul17_wdv]  AS (case when [depreciate]='N' OR [in_dt]>'2017-07-31' OR [end_dt]<'2017-07-01' OR [dis_dt]<'2017-07-01' then '0' else [old_cost]-case when '2017-07-31'>[end_dt] then [old_acc_dep]+(datediff(day,[in_dt],[end_dt])+'1')*round([cost]/[life_days],(2)) else [old_acc_dep]+(datediff(day,[in_dt],'2017-07-31')+'1')*round([cost]/[life_days],(2)) end end),
	[jul17_acc_dep]  AS (case when [depreciate]='N' OR [in_dt]>'2017-07-31' OR [end_dt]<'2017-07-01' OR [dis_dt]<'2017-07-01' then '0' else case when '2017-07-31'>[end_dt] then [old_acc_dep]+(datediff(day,[in_dt],[end_dt])+'1')*round([cost]/[life_days],(2)) else [old_acc_dep]+(datediff(day,[in_dt],'2017-07-31')+'1')*round([cost]/[life_days],(2)) end end),
	[aug17_dep]  AS (case when [depreciate]='N' OR [in_dt]>'2017-08-31' OR [end_dt]<'2017-08-01' OR [dis_dt]<'2017-08-01' then '0' else case when '2017-08-31'>[end_dt] then [old_acc_dep]+(datediff(day,[in_dt],[end_dt])+'1')*round([cost]/[life_days],(2)) else [old_acc_dep]+(datediff(day,[in_dt],'2017-08-31')+'1')*round([cost]/[life_days],(2)) end-case when [depreciate]='N' OR [in_dt]>'2017-07-31' OR [end_dt]<'2017-07-01' OR [dis_dt]<'2017-07-01' then '0' else case when '2017-07-31'>[end_dt] then [old_acc_dep]+(datediff(day,[in_dt],[end_dt])+'1')*round([cost]/[life_days],(2)) else [old_acc_dep]+(datediff(day,[in_dt],'2017-07-31')+'1')*round([cost]/[life_days],(2)) end end end),
	[aug17_wdv]  AS (case when [depreciate]='N' OR [in_dt]>'2017-08-31' OR [end_dt]<'2017-08-01' OR [dis_dt]<'2017-08-01' then '0' else [old_cost]-case when '2017-08-31'>[end_dt] then [old_acc_dep]+(datediff(day,[in_dt],[end_dt])+'1')*round([cost]/[life_days],(2)) else [old_acc_dep]+(datediff(day,[in_dt],'2017-08-31')+'1')*round([cost]/[life_days],(2)) end end),
	[aug17_acc_dep]  AS (case when [depreciate]='N' OR [in_dt]>'2017-08-31' OR [end_dt]<'2017-08-01' OR [dis_dt]<'2017-08-01' then '0' else case when '2017-08-31'>[end_dt] then [old_acc_dep]+(datediff(day,[in_dt],[end_dt])+'1')*round([cost]/[life_days],(2)) else [old_acc_dep]+(datediff(day,[in_dt],'2017-08-31')+'1')*round([cost]/[life_days],(2)) end end),
	[sep17_dep]  AS (case when [depreciate]='N' OR [in_dt]>'2017-09-30' OR [end_dt]<'2017-09-01' OR [dis_dt]<'2017-09-01' then '0' else case when '2017-09-30'>[end_dt] then [old_acc_dep]+(datediff(day,[in_dt],[end_dt])+'1')*round([cost]/[life_days],(2)) else [old_acc_dep]+(datediff(day,[in_dt],'2017-09-30')+'1')*round([cost]/[life_days],(2)) end-case when [depreciate]='N' OR [in_dt]>'2017-08-31' OR [end_dt]<'2017-08-01' OR [dis_dt]<'2017-08-01' then '0' else case when '2017-08-31'>[end_dt] then [old_acc_dep]+(datediff(day,[in_dt],[end_dt])+'1')*round([cost]/[life_days],(2)) else [old_acc_dep]+(datediff(day,[in_dt],'2017-08-31')+'1')*round([cost]/[life_days],(2)) end end end),
	[sep17_wdv]  AS (case when [depreciate]='N' OR [in_dt]>'2017-09-30' OR [end_dt]<'2017-09-01' OR [dis_dt]<'2017-09-01' then '0' else [old_cost]-case when '2017-09-30'>[end_dt] then [old_acc_dep]+(datediff(day,[in_dt],[end_dt])+'1')*round([cost]/[life_days],(2)) else [old_acc_dep]+(datediff(day,[in_dt],'2017-09-30')+'1')*round([cost]/[life_days],(2)) end end),
	[sep17_acc_dep]  AS (case when [depreciate]='N' OR [in_dt]>'2017-09-30' OR [end_dt]<'2017-09-01' OR [dis_dt]<'2017-09-01' then '0' else case when '2017-09-30'>[end_dt] then [old_acc_dep]+(datediff(day,[in_dt],[end_dt])+'1')*round([cost]/[life_days],(2)) else [old_acc_dep]+(datediff(day,[in_dt],'2017-09-30')+'1')*round([cost]/[life_days],(2)) end end),
	[oct17_dep]  AS (case when [depreciate]='N' OR [in_dt]>'2017-10-31' OR [end_dt]<'2017-10-01' OR [dis_dt]<'2017-10-01' then '0' else case when '2017-10-31'>[end_dt] then [old_acc_dep]+(datediff(day,[in_dt],[end_dt])+'1')*round([cost]/[life_days],(2)) else [old_acc_dep]+(datediff(day,[in_dt],'2017-10-31')+'1')*round([cost]/[life_days],(2)) end-case when [depreciate]='N' OR [in_dt]>'2017-09-30' OR [end_dt]<'2017-09-01' OR [dis_dt]<'2017-09-01' then '0' else case when '2017-09-30'>[end_dt] then [old_acc_dep]+(datediff(day,[in_dt],[end_dt])+'1')*round([cost]/[life_days],(2)) else [old_acc_dep]+(datediff(day,[in_dt],'2017-09-30')+'1')*round([cost]/[life_days],(2)) end end end),
	[oct17_wdv]  AS (case when [depreciate]='N' OR [in_dt]>'2017-10-31' OR [end_dt]<'2017-10-01' OR [dis_dt]<'2017-10-01' then '0' else [old_cost]-case when '2017-10-31'>[end_dt] then [old_acc_dep]+(datediff(day,[in_dt],[end_dt])+'1')*round([cost]/[life_days],(2)) else [old_acc_dep]+(datediff(day,[in_dt],'2017-10-31')+'1')*round([cost]/[life_days],(2)) end end),
	[oct17_acc_dep]  AS (case when [depreciate]='N' OR [in_dt]>'2017-10-31' OR [end_dt]<'2017-10-01' OR [dis_dt]<'2017-10-01' then '0' else case when '2017-10-31'>[end_dt] then [old_acc_dep]+(datediff(day,[in_dt],[end_dt])+'1')*round([cost]/[life_days],(2)) else [old_acc_dep]+(datediff(day,[in_dt],'2017-10-31')+'1')*round([cost]/[life_days],(2)) end end),
	[nov17_dep]  AS (case when [depreciate]='N' OR [in_dt]>'2017-11-30' OR [end_dt]<'2017-11-01' OR [dis_dt]<'2017-11-01' then '0' else case when '2017-11-30'>[end_dt] then [old_acc_dep]+(datediff(day,[in_dt],[end_dt])+'1')*round([cost]/[life_days],(2)) else [old_acc_dep]+(datediff(day,[in_dt],'2017-11-30')+'1')*round([cost]/[life_days],(2)) end-case when [depreciate]='N' OR [in_dt]>'2017-10-31' OR [end_dt]<'2017-10-01' OR [dis_dt]<'2017-10-01' then '0' else case when '2017-10-31'>[end_dt] then [old_acc_dep]+(datediff(day,[in_dt],[end_dt])+'1')*round([cost]/[life_days],(2)) else [old_acc_dep]+(datediff(day,[in_dt],'2017-10-31')+'1')*round([cost]/[life_days],(2)) end end end),
	[nov17_wdv]  AS (case when [depreciate]='N' OR [in_dt]>'2017-11-30' OR [end_dt]<'2017-11-01' OR [dis_dt]<'2017-11-01' then '0' else [old_cost]-case when '2017-11-30'>[end_dt] then [old_acc_dep]+(datediff(day,[in_dt],[end_dt])+'1')*round([cost]/[life_days],(2)) else [old_acc_dep]+(datediff(day,[in_dt],'2017-11-30')+'1')*round([cost]/[life_days],(2)) end end),
	[nov17_acc_dep]  AS (case when [depreciate]='N' OR [in_dt]>'2017-11-30' OR [end_dt]<'2017-11-01' OR [dis_dt]<'2017-11-01' then '0' else case when '2017-11-30'>[end_dt] then [old_acc_dep]+(datediff(day,[in_dt],[end_dt])+'1')*round([cost]/[life_days],(2)) else [old_acc_dep]+(datediff(day,[in_dt],'2017-11-30')+'1')*round([cost]/[life_days],(2)) end end),
	[dec17_dep]  AS (case when [depreciate]='N' OR [in_dt]>'2017-12-31' OR [end_dt]<'2017-12-01' OR [dis_dt]<'2017-12-01' then '0' else case when '2017-12-31'>[end_dt] then [old_acc_dep]+(datediff(day,[in_dt],[end_dt])+'1')*round([cost]/[life_days],(2)) else [old_acc_dep]+(datediff(day,[in_dt],'2017-12-31')+'1')*round([cost]/[life_days],(2)) end-case when [depreciate]='N' OR [in_dt]>'2017-11-30' OR [end_dt]<'2017-11-01' OR [dis_dt]<'2017-11-01' then '0' else case when '2017-11-30'>[end_dt] then [old_acc_dep]+(datediff(day,[in_dt],[end_dt])+'1')*round([cost]/[life_days],(2)) else [old_acc_dep]+(datediff(day,[in_dt],'2017-11-30')+'1')*round([cost]/[life_days],(2)) end end end),
	[dec17_wdv]  AS (case when [depreciate]='N' OR [in_dt]>'2017-12-31' OR [end_dt]<'2017-12-01' OR [dis_dt]<'2017-12-01' then '0' else [old_cost]-case when '2017-12-31'>[end_dt] then [old_acc_dep]+(datediff(day,[in_dt],[end_dt])+'1')*round([cost]/[life_days],(2)) else [old_acc_dep]+(datediff(day,[in_dt],'2017-12-31')+'1')*round([cost]/[life_days],(2)) end end),
	[dec17_acc_dep]  AS (case when [depreciate]='N' OR [in_dt]>'2017-12-31' OR [end_dt]<'2017-12-01' OR [dis_dt]<'2017-12-01' then '0' else case when '2017-12-31'>[end_dt] then [old_acc_dep]+(datediff(day,[in_dt],[end_dt])+'1')*round([cost]/[life_days],(2)) else [old_acc_dep]+(datediff(day,[in_dt],'2017-12-31')+'1')*round([cost]/[life_days],(2)) end end),
	[jan18_dep]  AS (case when [depreciate]='N' OR [in_dt]>'2018-01-31' OR [end_dt]<'2018-01-01' OR [dis_dt]<'2018-01-01' then '0' else case when '2018-01-31'>[end_dt] then [old_acc_dep]+(datediff(day,[in_dt],[end_dt])+'1')*round([cost]/[life_days],(2)) else [old_acc_dep]+(datediff(day,[in_dt],'2018-01-31')+'1')*round([cost]/[life_days],(2)) end-case when [depreciate]='N' OR [in_dt]>'2017-12-31' OR [end_dt]<'2017-12-01' OR [dis_dt]<'2017-12-01' then '0' else case when '2017-12-31'>[end_dt] then [old_acc_dep]+(datediff(day,[in_dt],[end_dt])+'1')*round([cost]/[life_days],(2)) else [old_acc_dep]+(datediff(day,[in_dt],'2017-12-31')+'1')*round([cost]/[life_days],(2)) end end end),
	[jan18_wdv]  AS (case when [depreciate]='N' OR [in_dt]>'2018-01-31' OR [end_dt]<'2018-01-01' OR [dis_dt]<'2018-01-01' then '0' else [old_cost]-case when '2018-01-31'>[end_dt] then [old_acc_dep]+(datediff(day,[in_dt],[end_dt])+'1')*round([cost]/[life_days],(2)) else [old_acc_dep]+(datediff(day,[in_dt],'2018-01-31')+'1')*round([cost]/[life_days],(2)) end end),
	[jan18_acc_dep]  AS (case when [depreciate]='N' OR [in_dt]>'2018-01-31' OR [end_dt]<'2018-01-01' OR [dis_dt]<'2018-01-01' then '0' else case when '2018-01-31'>[end_dt] then [old_acc_dep]+(datediff(day,[in_dt],[end_dt])+'1')*round([cost]/[life_days],(2)) else [old_acc_dep]+(datediff(day,[in_dt],'2018-01-31')+'1')*round([cost]/[life_days],(2)) end end),
	[feb18_dep]  AS (case when [depreciate]='N' OR [in_dt]>'2018-02-28' OR [end_dt]<'2018-02-01' OR [dis_dt]<'2018-02-01' then '0' else case when '2018-02-28'>[end_dt] then [old_acc_dep]+(datediff(day,[in_dt],[end_dt])+'1')*round([cost]/[life_days],(2)) else [old_acc_dep]+(datediff(day,[in_dt],'2018-02-28')+'1')*round([cost]/[life_days],(2)) end-case when [depreciate]='N' OR [in_dt]>'2018-01-31' OR [end_dt]<'2018-01-01' OR [dis_dt]<'2018-01-01' then '0' else case when '2018-01-31'>[end_dt] then [old_acc_dep]+(datediff(day,[in_dt],[end_dt])+'1')*round([cost]/[life_days],(2)) else [old_acc_dep]+(datediff(day,[in_dt],'2018-01-31')+'1')*round([cost]/[life_days],(2)) end end end),
	[feb18_wdv]  AS (case when [depreciate]='N' OR [in_dt]>'2018-02-28' OR [end_dt]<'2018-02-01' OR [dis_dt]<'2018-02-01' then '0' else [old_cost]-case when '2018-02-28'>[end_dt] then [old_acc_dep]+(datediff(day,[in_dt],[end_dt])+'1')*round([cost]/[life_days],(2)) else [old_acc_dep]+(datediff(day,[in_dt],'2018-02-28')+'1')*round([cost]/[life_days],(2)) end end),
	[feb18_acc_dep]  AS (case when [depreciate]='N' OR [in_dt]>'2018-02-28' OR [end_dt]<'2018-02-01' OR [dis_dt]<'2018-02-01' then '0' else case when '2018-02-28'>[end_dt] then [old_acc_dep]+(datediff(day,[in_dt],[end_dt])+'1')*round([cost]/[life_days],(2)) else [old_acc_dep]+(datediff(day,[in_dt],'2018-02-28')+'1')*round([cost]/[life_days],(2)) end end),
	[mar18_dep]  AS (case when [depreciate]='N' OR [in_dt]>'2018-03-31' OR [end_dt]<'2018-03-01' OR [dis_dt]<'2018-03-01' then '0' else case when '2018-03-31'>[end_dt] then [old_acc_dep]+(datediff(day,[in_dt],[end_dt])+'1')*round([cost]/[life_days],(2)) else [old_acc_dep]+(datediff(day,[in_dt],'2018-03-31')+'1')*round([cost]/[life_days],(2)) end-case when [depreciate]='N' OR [in_dt]>'2018-02-28' OR [end_dt]<'2018-02-01' OR [dis_dt]<'2018-02-01' then '0' else case when '2018-02-28'>[end_dt] then [old_acc_dep]+(datediff(day,[in_dt],[end_dt])+'1')*round([cost]/[life_days],(2)) else [old_acc_dep]+(datediff(day,[in_dt],'2018-02-28')+'1')*round([cost]/[life_days],(2)) end end end),
	[mar18_wdv]  AS (case when [depreciate]='N' OR [in_dt]>'2018-03-31' OR [end_dt]<'2018-03-01' OR [dis_dt]<'2018-03-01' then '0' else [old_cost]-case when '2018-03-31'>[end_dt] then [old_acc_dep]+(datediff(day,[in_dt],[end_dt])+'1')*round([cost]/[life_days],(2)) else [old_acc_dep]+(datediff(day,[in_dt],'2018-03-31')+'1')*round([cost]/[life_days],(2)) end end),
	[mar18_acc_dep]  AS (case when [depreciate]='N' OR [in_dt]>'2018-03-31' OR [end_dt]<'2018-03-01' OR [dis_dt]<'2018-03-01' then '0' else case when '2018-03-31'>[end_dt] then [old_acc_dep]+(datediff(day,[in_dt],[end_dt])+'1')*round([cost]/[life_days],(2)) else [old_acc_dep]+(datediff(day,[in_dt],'2018-03-31')+'1')*round([cost]/[life_days],(2)) end end)
) ON [PRIMARY] TEXTIMAGE_ON [PRIMARY]
GO

ALTER TABLE [dbo].[depreciation] ADD  CONSTRAINT [DF_depreciation_ast_id]  DEFAULT ('0') FOR [ast_id]
GO


